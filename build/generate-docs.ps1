# Documentation is auto-generated by DocFx.
# We need to install the tools and then auto-generate the documentation from the ~/doc folder.
# The generated files are then published as a Build Artifact and processed by a Release Pipeline.

if ([string]::IsNullOrEmpty(($env:BUILD_ARTIFACTSTAGINGDIRECTORY))) {
    Write-Host "BUILD_ARTIFACTSTAGINGDIRECTORY was not set. Not generating documentation."
    return
}

$targetDir = [System.IO.Path]::Combine(
    $env:BUILD_ARTIFACTSTAGINGDIRECTORY,
    "Documentation"
)

# DocFx uses this environment variable for fetching the sources.
# We want to always generate doc from the master branch.
# -> Temporarily set this env variable to master.
$prevBuildSourceBranchName = $env:BUILD_SOURCEBRANCHNAME
$env:BUILD_SOURCEBRANCHNAME = "master"

Write-Host "Installing DocFx..."
choco install docfx -y
Write-Host "DocFx installed."

Write-Host "Generating documentation..."
Set-Location doc
docfx -o "$targetDir"
Write-Host "Generated documentation."

# Reset env var (see above). Perhaps unnecessary?
$env:BUILD_SOURCEBRANCHNAME = $prevBuildSourceBranchName
